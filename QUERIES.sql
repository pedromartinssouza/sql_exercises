DROP VIEW IF EXISTS VENDAS_MENSAIS;
DROP VIEW IF EXISTS VENDAS_SUMARIZADAS;
DROP VIEW IF EXISTS ESTOQUE_DISPONIVEL;
DROP TABLE IF EXISTS TRANSACOES;
DROP TABLE IF EXISTS VENDAS;
DROP TABLE IF EXISTS PRODUTOS;
DROP TABLE IF EXISTS VENDEDORES;
DROP TABLE IF EXISTS COMPRADORES;

--#region CREATE_TABLES

CREATE TABLE PRODUTOS (
    ID_PRODUTO CHAR(20) NOT NULL,
    CODIGO_DE_BARRAS CHAR(20) NOT NULL,
    DATA_FABRICACAO DATE NOT NULL,
    CUSTO_UNITARIO REAL NOT NULL DEFAULT 0.0 CHECK (CUSTO_UNITARIO >= 0.0),
    MASSA REAL CHECK (MASSA >= 0.0),
    VOLUME REAL CHECK (VOLUME >= 0.0),
    LARGURA REAL CHECK (LARGURA >= 0.0),
    ALTURA REAL CHECK (ALTURA >= 0.0),
    COMPRIMENTO REAL CHECK (COMPRIMENTO >= 0.0),
    QUANTIDADE_INICIAL REAL NOT NULL CHECK (QUANTIDADE_INICIAL >= 0.0),
    PRIMARY KEY (ID_PRODUTO)
);

CREATE TABLE VENDEDORES (
    ID_VENDEDOR CHAR(8) NOT NULL,
    CPF CHAR(11) NOT NULL,
    NOME CHAR(100) NOT NULL,
    EMAIL CHAR(100) NOT NULL,
    PRIMARY KEY (ID_VENDEDOR)
);

CREATE TABLE COMPRADORES (
    ID_COMPRADOR CHAR(8) NOT NULL,
    CPF CHAR(11) NOT NULL,
    NOME CHAR(100) NOT NULL,
    TELEFONE CHAR(13),
    ENDERECO CHAR(100),
    PRIMARY KEY (ID_COMPRADOR)
);

CREATE TABLE VENDAS (
    DATA_VENDA DATE NOT NULL CHECK (DATA_VENDA <= CURRENT_DATE),
    ID_VENDEDOR CHAR(8) NOT NULL,
    ID_COMPRADOR CHAR(8) NOT NULL,
    PRIMARY KEY (DATA_VENDA, ID_VENDEDOR, ID_COMPRADOR),
    FOREIGN KEY (ID_VENDEDOR) REFERENCES VENDEDORES(ID_VENDEDOR),
    FOREIGN KEY (ID_COMPRADOR) REFERENCES COMPRADORES(ID_COMPRADOR)
);

CREATE TABLE TRANSACOES (
    ID_PRODUTO CHAR(20) NOT NULL,
    ID_VENDEDOR CHAR(8) NOT NULL,
    ID_COMPRADOR CHAR(8) NOT NULL,
    DATA_VENDA DATE NOT NULL CHECK (DATA_VENDA <= CURRENT_DATE),
    QUANTIDADE INTEGER NOT NULL CHECK (QUANTIDADE > 0),
    PRIMARY KEY (DATA_VENDA, ID_PRODUTO, ID_VENDEDOR, ID_COMPRADOR),
    FOREIGN KEY (ID_VENDEDOR) REFERENCES VENDEDORES(ID_VENDEDOR),
    FOREIGN KEY (ID_COMPRADOR) REFERENCES COMPRADORES(ID_COMPRADOR),
    FOREIGN KEY (ID_PRODUTO) REFERENCES PRODUTOS(ID_PRODUTO),
    FOREIGN KEY (DATA_VENDA, ID_VENDEDOR, ID_COMPRADOR) REFERENCES VENDAS(DATA_VENDA, ID_VENDEDOR, ID_COMPRADOR) ON DELETE CASCADE
);
CREATE INDEX IDX_VENDA ON TRANSACOES (DATA_VENDA, ID_VENDEDOR, ID_COMPRADOR);

--#endregion

--#region INSERTS
INSERT INTO PRODUTOS VALUES ('ARGILA', '11111111111111111111', '2020-01-01', 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 100.0);
INSERT INTO PRODUTOS VALUES ('CIMENT', '22222222222222222222', '2020-01-01', 1.0, 2.0, 2.0, 2.0, 2.0, 2.0, 100.0);
INSERT INTO PRODUTOS VALUES ('CONCRE', '33333333333333333333', '2020-01-01', 1.0, 3.0, 3.0, 3.0, 3.0, 3.0, 100.0);

INSERT INTO VENDEDORES VALUES ('IDCAR', '11111111111', 'Carlos', 'carlos@carlos.com');
INSERT INTO VENDEDORES VALUES ('IDLUI', '22222222222', 'Luis', 'luis@luis.com');
INSERT INTO VENDEDORES VALUES ('IDPED', '33333333333', 'Pedro', 'pedro@pedro.com');

INSERT INTO COMPRADORES VALUES ('GUST', '12345678901', 'Gustavo', '51111111111', 'Rua 1');
INSERT INTO COMPRADORES VALUES ('LORE', '23456789012', 'Lorenzo', '52222222222', 'Rua 2');
INSERT INTO COMPRADORES VALUES ('SORR', '34567890123', 'Sor', '53333333333', 'Rua 3');

INSERT INTO VENDAS VALUES ('2020-01-01', 'IDCAR', 'GUST');
INSERT INTO VENDAS VALUES ('2020-02-03', 'IDLUI', 'SORR');
INSERT INTO VENDAS VALUES ('2020-02-04', 'IDLUI', 'GUST');
INSERT INTO VENDAS VALUES ('2020-03-05', 'IDPED', 'LORE');
INSERT INTO VENDAS VALUES ('2020-03-06', 'IDPED', 'SORR');
INSERT INTO VENDAS VALUES ('2020-04-07', 'IDCAR', 'GUST');
INSERT INTO VENDAS VALUES ('2020-04-08', 'IDCAR', 'LORE');
INSERT INTO VENDAS VALUES ('2020-05-09', 'IDLUI', 'SORR');
INSERT INTO VENDAS VALUES ('2020-05-10', 'IDLUI', 'GUST');
INSERT INTO VENDAS VALUES ('2020-06-11', 'IDPED', 'LORE');
INSERT INTO VENDAS VALUES ('2020-06-12', 'IDPED', 'SORR');
INSERT INTO VENDAS VALUES ('2020-07-13', 'IDCAR', 'GUST');
INSERT INTO VENDAS VALUES ('2020-07-14', 'IDCAR', 'LORE');
INSERT INTO VENDAS VALUES ('2020-08-15', 'IDLUI', 'SORR');
INSERT INTO VENDAS VALUES ('2020-08-16', 'IDLUI', 'GUST');
INSERT INTO VENDAS VALUES ('2020-09-17', 'IDPED', 'LORE');
INSERT INTO VENDAS VALUES ('2020-09-18', 'IDPED', 'SORR');
INSERT INTO VENDAS VALUES ('2020-10-19', 'IDCAR', 'GUST');
INSERT INTO VENDAS VALUES ('2020-10-20', 'IDCAR', 'LORE');
INSERT INTO VENDAS VALUES ('2020-11-21', 'IDLUI', 'SORR');
INSERT INTO VENDAS VALUES ('2020-11-22', 'IDLUI', 'GUST');
INSERT INTO VENDAS VALUES ('2020-12-23', 'IDPED', 'LORE');
INSERT INTO VENDAS VALUES ('2020-12-24', 'IDPED', 'SORR');
INSERT INTO VENDAS VALUES ('2020-01-01', 'IDPED', 'SORR');
INSERT INTO VENDAS VALUES ('2020-01-02', 'IDPED', 'LORE');
INSERT INTO VENDAS VALUES ('2020-02-03', 'IDLUI', 'GUST');
INSERT INTO VENDAS VALUES ('2020-02-04', 'IDLUI', 'SORR');
INSERT INTO VENDAS VALUES ('2020-03-05', 'IDCAR', 'LORE');
INSERT INTO VENDAS VALUES ('2020-03-06', 'IDCAR', 'GUST');
INSERT INTO VENDAS VALUES ('2020-04-07', 'IDPED', 'SORR');
INSERT INTO VENDAS VALUES ('2020-04-08', 'IDPED', 'LORE');
INSERT INTO VENDAS VALUES ('2020-05-09', 'IDLUI', 'GUST');
INSERT INTO VENDAS VALUES ('2020-05-10', 'IDLUI', 'SORR');
INSERT INTO VENDAS VALUES ('2020-06-11', 'IDCAR', 'LORE');
INSERT INTO VENDAS VALUES ('2020-06-12', 'IDCAR', 'GUST');
INSERT INTO VENDAS VALUES ('2020-07-13', 'IDPED', 'SORR');
INSERT INTO VENDAS VALUES ('2020-07-14', 'IDPED', 'LORE');
INSERT INTO VENDAS VALUES ('2020-08-15', 'IDLUI', 'GUST');
INSERT INTO VENDAS VALUES ('2020-08-16', 'IDLUI', 'SORR');
INSERT INTO VENDAS VALUES ('2020-09-17', 'IDCAR', 'LORE');
INSERT INTO VENDAS VALUES ('2020-09-18', 'IDPED', 'GUST');
INSERT INTO VENDAS VALUES ('2020-10-19', 'IDLUI', 'SORR');
INSERT INTO VENDAS VALUES ('2020-10-20', 'IDLUI', 'LORE');
INSERT INTO VENDAS VALUES ('2020-11-21', 'IDCAR', 'GUST');
INSERT INTO VENDAS VALUES ('2020-11-22', 'IDCAR', 'SORR');
INSERT INTO VENDAS VALUES ('2020-12-24', 'IDPED', 'GUST');

INSERT INTO TRANSACOES VALUES ('ARGILA', 'IDCAR', 'GUST', '2020-01-01', 1);
INSERT INTO TRANSACOES VALUES ('CONCRE', 'IDCAR', 'GUST', '2020-01-01', 4);
INSERT INTO TRANSACOES VALUES ('ARGILA', 'IDLUI', 'SORR', '2020-02-03', 5);
INSERT INTO TRANSACOES VALUES ('ARGILA', 'IDLUI', 'GUST', '2020-02-04', 6);
INSERT INTO TRANSACOES VALUES ('CIMENT', 'IDPED', 'LORE', '2020-03-05', 12);
INSERT INTO TRANSACOES VALUES ('CIMENT', 'IDPED', 'SORR', '2020-03-06', 16);
INSERT INTO TRANSACOES VALUES ('CIMENT', 'IDCAR', 'GUST', '2020-04-07', 1);
INSERT INTO TRANSACOES VALUES ('CIMENT', 'IDCAR', 'LORE', '2020-04-08', 4);
INSERT INTO TRANSACOES VALUES ('CONCRE', 'IDLUI', 'SORR', '2020-05-09', 6);
INSERT INTO TRANSACOES VALUES ('CONCRE', 'IDLUI', 'GUST', '2020-05-10', 5);
INSERT INTO TRANSACOES VALUES ('CONCRE', 'IDPED', 'LORE', '2020-06-11', 8);
INSERT INTO TRANSACOES VALUES ('CONCRE', 'IDPED', 'SORR', '2020-06-12', 19);
INSERT INTO TRANSACOES VALUES ('ARGILA', 'IDCAR', 'GUST', '2020-07-13', 8);
INSERT INTO TRANSACOES VALUES ('ARGILA', 'IDCAR', 'LORE', '2020-07-14', 11);
INSERT INTO TRANSACOES VALUES ('ARGILA', 'IDLUI', 'SORR', '2020-08-15', 12);
INSERT INTO TRANSACOES VALUES ('ARGILA', 'IDLUI', 'GUST', '2020-08-16', 3);
INSERT INTO TRANSACOES VALUES ('CIMENT', 'IDPED', 'LORE', '2020-09-17', 6);
INSERT INTO TRANSACOES VALUES ('CIMENT', 'IDPED', 'SORR', '2020-09-18', 7);
INSERT INTO TRANSACOES VALUES ('CIMENT', 'IDCAR', 'GUST', '2020-10-19', 6);
INSERT INTO TRANSACOES VALUES ('CIMENT', 'IDCAR', 'LORE', '2020-10-20', 9);
INSERT INTO TRANSACOES VALUES ('CONCRE', 'IDLUI', 'SORR', '2020-11-21', 1);
INSERT INTO TRANSACOES VALUES ('CONCRE', 'IDLUI', 'GUST', '2020-11-22', 1);
INSERT INTO TRANSACOES VALUES ('CONCRE', 'IDPED', 'LORE', '2020-12-23', 1);
INSERT INTO TRANSACOES VALUES ('CONCRE', 'IDPED', 'SORR', '2020-12-24', 11);
INSERT INTO TRANSACOES VALUES ('CONCRE', 'IDPED', 'SORR', '2020-01-01', 4);
INSERT INTO TRANSACOES VALUES ('CONCRE', 'IDPED', 'LORE', '2020-01-02', 2);
INSERT INTO TRANSACOES VALUES ('CONCRE', 'IDLUI', 'GUST', '2020-02-03', 1);
INSERT INTO TRANSACOES VALUES ('CONCRE', 'IDLUI', 'SORR', '2020-02-04', 7);
INSERT INTO TRANSACOES VALUES ('CIMENT', 'IDCAR', 'LORE', '2020-03-05', 8);
INSERT INTO TRANSACOES VALUES ('CIMENT', 'IDCAR', 'GUST', '2020-03-06', 9);
INSERT INTO TRANSACOES VALUES ('CIMENT', 'IDPED', 'SORR', '2020-04-07', 1);
INSERT INTO TRANSACOES VALUES ('CIMENT', 'IDPED', 'LORE', '2020-04-08', 1);
INSERT INTO TRANSACOES VALUES ('ARGILA', 'IDLUI', 'GUST', '2020-05-09', 2);
INSERT INTO TRANSACOES VALUES ('ARGILA', 'IDLUI', 'SORR', '2020-05-10', 4);
INSERT INTO TRANSACOES VALUES ('ARGILA', 'IDCAR', 'LORE', '2020-06-11', 3);
INSERT INTO TRANSACOES VALUES ('ARGILA', 'IDCAR', 'GUST', '2020-06-12', 5);
INSERT INTO TRANSACOES VALUES ('CONCRE', 'IDPED', 'SORR', '2020-07-13', 14);
INSERT INTO TRANSACOES VALUES ('CONCRE', 'IDPED', 'LORE', '2020-07-14', 2);
INSERT INTO TRANSACOES VALUES ('CONCRE', 'IDLUI', 'GUST', '2020-08-15', 2);
INSERT INTO TRANSACOES VALUES ('CONCRE', 'IDLUI', 'SORR', '2020-08-16', 15);
INSERT INTO TRANSACOES VALUES ('CIMENT', 'IDCAR', 'LORE', '2020-09-17', 2);
INSERT INTO TRANSACOES VALUES ('CIMENT', 'IDPED', 'GUST', '2020-09-18', 3);
INSERT INTO TRANSACOES VALUES ('CIMENT', 'IDLUI', 'SORR', '2020-10-19', 8);
INSERT INTO TRANSACOES VALUES ('CIMENT', 'IDLUI', 'LORE', '2020-10-20', 7);
INSERT INTO TRANSACOES VALUES ('ARGILA', 'IDCAR', 'GUST', '2020-11-21', 6);
INSERT INTO TRANSACOES VALUES ('ARGILA', 'IDCAR', 'SORR', '2020-11-22', 8);
INSERT INTO TRANSACOES VALUES ('ARGILA', 'IDPED', 'LORE', '2020-12-23', 9);
INSERT INTO TRANSACOES VALUES ('ARGILA', 'IDPED', 'GUST', '2020-12-24', 4);
--#endregion

CREATE VIEW VENDAS_MENSAIS (VENDEDOR, NOME, QUANTIDADE_VENDIDA, VALOR_TOTAL) AS
    SELECT 
        TRANSACOES.ID_VENDEDOR, VENDEDORES.NOME, SUM(TRANSACOES.QUANTIDADE), SUM(TRANSACOES.QUANTIDADE * PRODUTOS.CUSTO_UNITARIO)
    FROM
        TRANSACOES
        LEFT JOIN PRODUTOS ON TRANSACOES.ID_PRODUTO = PRODUTOS.ID_PRODUTO
        LEFT JOIN VENDEDORES ON TRANSACOES.ID_VENDEDOR = VENDEDORES.ID_VENDEDOR
    WHERE 
        TRANSACOES.ID_PRODUTO = PRODUTOS.ID_PRODUTO AND
        DATA_VENDA >= '2020-01-01' AND DATA_VENDA <= '2020-01-31'
    GROUP BY
        TRANSACOES.ID_VENDEDOR, VENDEDORES.NOME;

CREATE VIEW VENDAS_SUMARIZADAS (ID_VENDA, VALOR_TOTAL, PRODUTOS, NOME_VENDEDOR, NOME_COMPRADOR) AS
    SELECT 
        CONCAT(
            TRANSACOES.DATA_VENDA, TRANSACOES.ID_VENDEDOR, TRANSACOES.ID_COMPRADOR
        ),
        SUM(TRANSACOES.QUANTIDADE * PRODUTOS.CUSTO_UNITARIO),
        STRING_AGG(PRODUTOS.ID_PRODUTO, ','),
        VENDEDORES.NOME,
        COMPRADORES.NOME
    FROM
        TRANSACOES
        LEFT JOIN PRODUTOS ON TRANSACOES.ID_PRODUTO = PRODUTOS.ID_PRODUTO
        LEFT JOIN VENDEDORES ON TRANSACOES.ID_VENDEDOR = VENDEDORES.ID_VENDEDOR
        LEFT JOIN COMPRADORES ON TRANSACOES.ID_COMPRADOR = COMPRADORES.ID_COMPRADOR
    GROUP BY
        TRANSACOES.DATA_VENDA, TRANSACOES.ID_VENDEDOR, TRANSACOES.ID_COMPRADOR,
        VENDEDORES.NOME,
        COMPRADORES.NOME
    ORDER BY
        TRANSACOES.DATA_VENDA DESC,
        TRANSACOES.ID_VENDEDOR DESC,
        TRANSACOES.ID_COMPRADOR DESC;

CREATE VIEW ESTOQUE_DISPONIVEL (ID_PRODUTO, QUANTIDADE_DISPONIVEL) AS
    SELECT 
        PRODUTOS.ID_PRODUTO, PRODUTOS.QUANTIDADE_INICIAL - SUM(TRANSACOES.QUANTIDADE)
    FROM
        PRODUTOS
        LEFT JOIN TRANSACOES ON PRODUTOS.ID_PRODUTO = TRANSACOES.ID_PRODUTO
    GROUP BY
        PRODUTOS.ID_PRODUTO;
SELECT * FROM TRANSACOES;
SELECT * FROM VENDAS_MENSAIS;
SELECT * FROM VENDAS_SUMARIZADAS;
SELECT * FROM ESTOQUE_DISPONIVEL;

DELETE FROM VENDAS WHERE DATA_VENDA = '2020-12-23' AND ID_VENDEDOR = 'IDPED' AND ID_COMPRADOR = 'LORE';

SELECT * FROM VENDAS_SUMARIZADAS;